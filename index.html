<!doctype html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>日文50音學習 | Japanese 50 Sounds</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reset.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/theme/white.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/plugin/highlight/monokai.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Stroke Order Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dmak@0.3.1/dist/dmak.min.js"></script>

    <style>
        :root {
            --r-main-font: 'Noto Sans TC', sans-serif;
            --r-heading-font: 'Noto Serif JP', serif;
        }

        .reveal {
            font-family: var(--r-main-font);
        }

        /* Sakura Watermark Background */
        .reveal::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('sakura_bg.png');
            background-size: 400px;
            /* Adjust size for pattern */
            background-repeat: repeat;
            opacity: 0.15;
            /* Faint watermark */
            z-index: -1;
            pointer-events: none;
        }

        .reveal h1,
        .reveal h2,
        .reveal h3,
        .reveal h4,
        .reveal h5,
        .reveal h6 {
            font-family: var(--r-heading-font);
        }

        .jp-char {
            font-family: 'Noto Serif JP', serif;
        }

        /* 50 Sounds Table Styles */
        .gojuon-table {
            font-size: 0.5em;
            /* Reduced from 0.6em */
            width: 100%;
            border-collapse: collapse;
        }

        .gojuon-table th,
        .gojuon-table td {
            border: 1px solid #ddd;
            padding: 4px;
            /* Reduced from 8px */
            text-align: center;
        }

        .gojuon-table th {
            background-color: #f2f2f2;
            color: #333;
        }

        /* Kana Card Styles */
        .kana-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            color: #333;
        }

        .kana-main {
            font-size: 6em;
            margin: 0;
            line-height: 1;
            font-family: 'Noto Serif JP', serif;
            color: #d32f2f;
            /* Traditional Japanaese red-ish */
        }

        .kana-sub {
            font-size: 1.5em;
            color: #666;
            margin: 10px 0;
        }

        /* Adjust Reveal.js controls to avoid overlap with global nav */
        .reveal .controls {
            bottom: 60px !important;
        }

        /* Global Navigation Styles */
        .global-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            padding: 10px 0;
            z-index: 1000;
            /* Ensure it stays on top of reveal.js */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .global-nav a {
            text-decoration: none;
            color: #555;
            margin: 0 15px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: bold;
            font-size: 0.9em;
            transition: color 0.3s ease;
        }

        /* Sakura Transition Effect */
        #sakura-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            pointer-events: none;
            overflow: hidden;
        }

        .sakura-petal {
            position: absolute;
            background-image: url('sakura_bg.png');
            /* Reuse texture or use a shape */
            background-size: cover;
            opacity: 0;
            border-radius: 100% 0 100% 0;
            /* Petal shape if no image */
            background: linear-gradient(135deg, #ffc0cb 0%, #ffdde1 100%);
            /* Fallback shape */
        }

        .sakura-animate {
            animation: fall linear forwards;
        }

        @keyframes fall {
            0% {
                opacity: 0;
                top: -10%;
                transform: translateX(0) rotate(0deg);
            }

            10% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
                top: 110%;
                transform: translateX(200px) rotate(360deg);
            }
        }

        .kana-stroke {
            font-size: 1em;
            color: #999;
            font-style: italic;
        }

        .vocab-section {
            margin-top: 30px;
            text-align: left;
            width: 80%;
        }

        .vocab-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            font-size: 0.8em;
        }

        /* Audio Interaction Styles */
        .kana-main,
        .vocab-item .jp-char {
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }

        .kana-main:hover,
        .vocab-item:hover .jp-char {
            color: #b71c1c;
            /* Darker red on hover */
            transform: scale(1.1);
        }

        .kana-main:active,
        .vocab-item:active .jp-char {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section data-markdown="slides.md" data-separator="^\r?\n---\r?\n$"
                data-separator-vertical="^\r?\n--\r?\n$"></section>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/plugin/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/plugin/notes/notes.js"></script>
    <script>
        Reveal.initialize({
            controls: true,
            progress: true,
            center: true,
            hash: true,
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
        });

        // Speech Synthesis Support
        function speakText(text) {
            if (!window.speechSynthesis) {
                console.error("Web Speech API not supported.");
                return;
            }

            // Cancel any current speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8; // Slightly slower for learning
            utterance.pitch = 1;

            // Try to set a Japanese voice
            const voices = window.speechSynthesis.getVoices();
            // console.log("Available voices:", voices.map(v => v.name + " (" + v.lang + ")"));

            // Prioritize Google Japanese, then any Japanese, then generic
            const jpVoice = voices.find(v => v.lang === 'ja-JP' && v.name.includes('Google')) ||
                voices.find(v => v.lang === 'ja-JP');

            if (jpVoice) {
                utterance.voice = jpVoice;
                // console.log("Using voice:", jpVoice.name);
            } else {
                console.warn("No specific Japanese voice found. Using default.");
                // Some browsers might auto-detect language from text, but setting lang is safer
                utterance.lang = 'ja-JP';
            }

            window.speechSynthesis.speak(utterance);
        }

        // Ensure voices are loaded (Chrome sometimes needs this)
        window.speechSynthesis.onvoiceschanged = function () {
            const voices = window.speechSynthesis.getVoices();
            // console.log("Voices loaded:", voices.length);
        };

        // Event Delegation for clicks
        document.addEventListener('click', function (e) {
            // Check if clicked element or its parent is a target
            let target = e.target;
            let textToSpeak = "";

            // 1. Main Kana Character (.kana-main)
            if (target.classList.contains('kana-main')) {
                textToSpeak = target.innerText;
            }
            // 2. Vocabulary Item (.jp-char inside .vocab-item)
            else if (target.classList.contains('jp-char') && target.closest('.vocab-item')) {
                textToSpeak = target.innerText;
            }
            // 3. Handle if user clicked a span inside .kana-main (unlikely structure but safe)
            else if (target.parentElement && target.parentElement.classList.contains('kana-main')) {
                textToSpeak = target.parentElement.innerText;
            }

            if (textToSpeak) {
                // Remove non-Japanese characters if any (e.g. spaces or extra punctuation not part of the word)
                // actually, best to just speak what's there, usually it's clean.
                console.log("Speaking:", textToSpeak);
                speakText(textToSpeak);
            }
        });

        // --- Stroke Order Animation Logic ---

        // Helper to get hex unicode for KanjiVG file naming
        function getKanjiVGUnicode(char) {
            let code = char.charCodeAt(0).toString(16).toUpperCase();
            // We don't pad here for filenames if we handle it in URI, 
            // but for logging/checking length we might want to.
            return code;
        }

        let currentDmak = null;

        function handleSlideChange(currentSlide) {
            // 1. Cleanup existing animation
            const existingContainer = document.getElementById('dmak-container');
            if (existingContainer) {
                existingContainer.remove();
                currentDmak = null;
            }

            // 2. Check if current slide has a kana card
            const kanaMain = currentSlide.querySelector('.kana-main');

            if (kanaMain) {
                const char = kanaMain.innerText.trim().charAt(0); // Get the character
                if (!char) return;

                // Create container for animation
                const container = document.createElement('div');
                container.id = 'dmak-container';
                container.style.position = 'absolute';
                container.style.top = '0';
                container.style.right = '0';
                container.style.width = '150px';
                container.style.height = '150px';
                container.style.zIndex = '10';
                // container.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                // container.style.borderRadius = '10px';
                // container.style.border = '1px solid #ccc';

                // Position relative to the card if possible? 
                // The card is centered. Let's put the stroke order in the top right of the SLIDE for now.
                // Or maybe inside the card?
                // Let's try appending to the card itself if we can find it.

                const card = currentSlide.querySelector('.kana-card');
                if (card) {
                    card.style.position = 'relative'; // Ensure card is a positioning context
                    container.style.top = '10px';
                    container.style.right = '10px';
                    container.style.width = '100px'; // Smaller inside card
                    container.style.height = '100px';
                    container.style.border = 'none';
                    container.style.backgroundColor = 'transparent';
                    card.appendChild(container);
                } else {
                    currentSlide.appendChild(container); // Fallback
                }

                const unicodeHex = getKanjiVGUnicode(char);
                const uriBase = 'https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/';

                // dmak (CDN version) appears to pad to 5 digits automatically.
                // We do NOT need to add '0' manually for 4-digit codes.

                console.log(`Loading stroke order for ${char} (U+${unicodeHex}) using base ${uriBase}`);

                // Initialize dmak
                try {
                    // Pass the CHARACTER, not the unicode string
                    currentDmak = new Dmak(char, {
                        'element': 'dmak-container',
                        'uri': uriBase,
                        'step': 0.02, // stroke speed
                        'stroke': {
                            'order': {
                                'visible': true,
                                'attr': {
                                    'font-size': '8',
                                    'fill': '#999'
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error initializing dmak:", e);
                }
            }
        }

        // Sakura Transition Logic
        function triggerSakuraBlizzard() {
            const container = document.getElementById('sakura-container');
            if (!container) return;

            // Create 30 petals
            for (let i = 0; i < 30; i++) {
                const petal = document.createElement('div');
                petal.classList.add('sakura-petal');
                petal.classList.add('sakura-animate');

                // Randomize starting position and animation duration
                const startLeft = Math.random() * 100;
                const duration = 1.5 + Math.random() * 1.5; // 1.5s - 3s
                const delay = Math.random() * 0.5;
                const size = 10 + Math.random() * 10;

                petal.style.left = startLeft + 'vw';
                petal.style.animationDuration = duration + 's';
                petal.style.animationDelay = delay + 's';
                petal.style.width = size + 'px';
                petal.style.height = size + 'px';

                container.appendChild(petal);

                // Remove petal after animation
                setTimeout(() => {
                    petal.remove();
                }, (duration + delay) * 1000);
            }
        }

        Reveal.on('ready', event => {
            // Create container
            const container = document.createElement('div');
            container.id = 'sakura-container';
            document.body.appendChild(container);

            handleSlideChange(event.currentSlide);
        });

        Reveal.on('slidechanged', event => {
            handleSlideChange(event.currentSlide);
            triggerSakuraBlizzard();
        });

        console.log("VERSION 3 DEBUG - STROKE ORDER FIX"); // Kept for history
        Reveal.initialize({
            controls: true,
            progress: true,
            center: true,
            hash: true,
            transition: 'slide', // Japanese sliding door effect
            transitionSpeed: 'slow', // Slower for elegance
            backgroundTransition: 'slide',
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
        });
    </script>

    <div class="global-nav">
        <a href="#/0">首頁</a>
        <a href="#/outline">大綱</a>
        <a href="#/gojuon">五十音圖</a>
        <a href="#/hiragana-intro">平假名</a>
        <a href="#/katakana-intro">片假名</a>
        <a href="#/quiz">測驗</a>
    </div>
</body>

</html>